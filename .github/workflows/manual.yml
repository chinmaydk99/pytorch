name: Crowdsource Skipped Tests

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'True to print logs without creating issues'
        required: true
        default: 'false'
        type: boolean

permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  scan-and-create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for @skipIfRocm and Create Issues
        env:
          # This now pulls the Key you just saved in Settings
          GH_TOKEN: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          PROJECT_NAME: "IFU_Automatic_Issues_Test"
          DRY_RUN: ${{ inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Starting Scan for Skipped ROCm Tests ==="
          if [[ "$DRY_RUN" == "true" ]]; then echo "⚠️ DRY RUN MODE ENABLED"; fi

          # --- SETUP: Ensure Label Exists ---
          echo "Ensuring 'rocm-skipped' label exists..."
          gh label create "rocm-skipped" \
            --color "d73a4a" \
            --description "Tests skipped on ROCm platform" \
            --force || true

          # --- MAIN LOOP ---
          grep -rn "@skipIfRocm" test/ --include="*.py" | while IFS=: read -r filepath line_number line_content; do
            
            # 1. Extract Test Name
            test_name=$(awk -v start="$line_number" 'NR >= start && /^[[:space:]]*(def|class)[[:space:]]+/ {print $2; exit}' "$filepath" | sed 's/[(:].*//')
            
            if [[ -z "$test_name" ]]; then
              echo "⚠️  [Skip] Could not extract test name at ${filepath}:${line_number}."
              continue
            fi
            
            test_name=$(echo "$test_name" | tr -d '[:space:]')
            
            # 2. Extract Skip Reason
            if [[ "$line_content" == *"("* ]]; then
                 skip_reason=$(echo "$line_content" | grep -oP '@skipIfRocm\(\K.*?(?=\))' | tr -d '"' || echo "Parsing failed")
            else
                 skip_reason="Unspecified (Blank Decorator)"
            fi

            echo "Processing: $test_name ($filepath)"

            # 3. Check for Duplicates
            existing_issue=$(gh issue list \
              --repo "${{ github.repository }}" \
              --search "\"$test_name\" in:title label:rocm-skipped state:open" \
              --json number \
              --jq '.[0].number')

            if [[ -n "$existing_issue" ]]; then
              echo "  ✓ Issue already exists (#$existing_issue). Skipping."
              continue
            fi

            # 4. Draft Issue Content
            {
              echo "### Skipped ROCm Test: \`${test_name}\`"
              echo ""
              echo "This test is currently marked with \`@skipIfRocm\` and needs to be addressed."
              echo ""
              echo "- **File:** \`${filepath}\`"
              echo "- **Line:** ${line_number}"
              echo "- **Reason:** ${skip_reason}"
              echo ""
              echo "[View Code](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/${filepath}#L${line_number})"
              echo ""
              echo "---"
              echo "*Auto-generated by Skipped Test Tracker*"
            } > /tmp/issue_body.txt

            # 5. Create the Issue AND Add to Project
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "  [DRY RUN] Would create issue for $test_name"
            else
              if gh issue create \
                --repo "${{ github.repository }}" \
                --title "[ROCm Skip] ${test_name}" \
                --body-file /tmp/issue_body.txt \
                --label "rocm-skipped" \
                --project "$PROJECT_NAME"; then
                  echo "  ✓ Issue created and added to Project."
                  sleep 2
              else
                  echo "  ❌ FAILED. Ensure PROJECT_ACCESS_TOKEN has 'project' scope."
              fi
            fi

          done
          echo "=== Scan Complete ==="
