name: Crowdsource Skipped Tests

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'True to print logs without creating issues'
        required: true
        default: 'false'
        type: boolean

permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  scan-and-create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for @skipIfRocm and Create Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # IMPORTANT: If "Project not found" error occurs, comment out the PROJECT_NAME line below
          PROJECT_NAME: "IFU_Automatic_Issues_Test"
          ASSIGNEE: "vivianlee-amd"
          DRY_RUN: ${{ inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Starting Scan for Skipped ROCm Tests ==="
          if [[ "$DRY_RUN" == "true" ]]; then echo "⚠️ DRY RUN MODE ENABLED"; fi

          grep -rn "@skipIfRocm" test/ --include="*.py" | while IFS=: read -r filepath line_number line_content; do
            
            # --- 1. Extract Test Name ---
            # Uses awk to find the first 'def' or 'class' definition after the decorator
            test_name=$(awk -v start="$line_number" 'NR >= start && /^[[:space:]]*(def|class)[[:space:]]+/ {print $2; exit}' "$filepath" | sed 's/[(:].*//')
            
            if [[ -z "$test_name" ]]; then
              echo "⚠️  [Skip] Could not extract test name at ${filepath}:${line_number}. Skipping."
              continue
            fi
            
            test_name=$(echo "$test_name" | tr -d '[:space:]')
            
            # --- 2. Extract Skip Reason ---
            if [[ "$line_content" == *"("* ]]; then
                 skip_reason=$(echo "$line_content" | grep -oP '@skipIfRocm\(\K.*?(?=\))' | tr -d '"' || echo "Parsing failed")
            else
                 skip_reason="Unspecified (Blank Decorator)"
            fi

            echo "Processing: $test_name ($filepath)"

            # --- 3. Check for Existing Issues ---
            existing_issue=$(gh issue list \
              --repo "${{ github.repository }}" \
              --search "\"$test_name\" in:title label:rocm-skipped state:open" \
              --json number \
              --jq '.[0].number')

            if [[ -n "$existing_issue" ]]; then
              echo "  ✓ Issue already exists (#$existing_issue). Skipping."
              continue
            fi

            # --- 4. Construct Issue Body ---
            # Using grouped echo to safely write to file (Fixes YAML indentation errors)
            {
              echo "### Skipped ROCm Test: \`${test_name}\`"
              echo ""
              echo "This test is currently marked with \`@skipIfRocm\` and needs to be addressed."
              echo ""
              echo "- **File:** \`${filepath}\`"
              echo "- **Line:** ${line_number}"
              echo "- **Reason:** ${skip_reason}"
              echo ""
              echo "[View Code](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/${filepath}#L${line_number})"
              echo ""
              echo "---"
              echo "*Auto-generated by Skipped Test Tracker*"
            } > /tmp/issue_body.txt

            # --- 5. Create Issue ---
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "  [DRY RUN] Would create issue for $test_name"
            else
              gh issue create \
                --repo "${{ github.repository }}" \
                --title "[ROCm Skip] ${test_name}" \
                --body-file /tmp/issue_body.txt \
                --label "rocm-skipped" \
                --assignee "$ASSIGNEE" \
                --project "$PROJECT_NAME" \
                || echo "  ❌ Error creating issue (Project/Assignee permissions?)"
              
              echo "  ✓ Issue created."
              sleep 2
            fi

          done
          echo "=== Scan Complete ==="
