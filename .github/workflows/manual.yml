name: Crowdsource Skipped Tests (Create Issues)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'True to print logs without creating issues'
        required: true
        default: 'false'
        type: boolean

permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  scan-and-create-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for @skipIfRocm and Create Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # IMPORTANT: Ensure this Project exists in the repo/org. 
          # If using a Project V2 (Board), you might need a PAT instead of GITHUB_TOKEN.
          PROJECT_NAME: "IFU_Automatic_Issues_Test" 
          ASSIGNEE: "vivianlee-amd"
          DRY_RUN: ${{ inputs.dry_run }}
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Starting Scan for Skipped ROCm Tests ==="
          if [[ "$DRY_RUN" == "true" ]]; then echo "⚠️ DRY RUN MODE ENABLED"; fi

          # 1. Find all occurrences of @skipIfRocm
          # We use grep to get line numbers, then loop
          grep -rn "@skipIfRocm" test/ --include="*.py" | while IFS=: read -r filepath line_number line_content; do
            
            # 2. Extract Test Name
            # awk looks ahead from the match line to find the next 'def' or 'class' definition
            # This handles decorators that span multiple lines or have stacking decorators
            test_name=$(awk -v start="$line_number" 'NR >= start && /^[[:space:]]*(def|class)[[:space:]]+/ {print $2; exit}' "$filepath" | sed 's/[(:].*//')
            
            if [[ -z "$test_name" ]]; then
              echo "⚠️  [Skip] Could not extract test name at ${filepath}:${line_number}. Skipping."
              continue
            fi
            
            # Clean variable
            test_name=$(echo "$test_name" | tr -d '[:space:]')
            
            # 3. Extract Skip Reason
            # Tries to grab content inside ("...") or ('...')
            if [[ "$line_content" == *"("* ]]; then
                 skip_reason=$(echo "$line_content" | grep -oP '@skipIfRocm\(\K.*?(?=\))' | tr -d '"' || echo "Parsing failed")
            else
                 skip_reason="Unspecified (Blank Decorator)"
            fi

            echo "Processing: $test_name ($filepath)"

            # 4. Check for Existing Issues (Duplicate Prevention)
            # Searches for open issues with the test name in the title AND the specific label
            existing_issue=$(gh issue list \
              --repo "${{ github.repository }}" \
              --search "\"$test_name\" in:title label:rocm-skipped state:open" \
              --json number \
              --jq '.[0].number')

            if [[ -n "$existing_issue" ]]; then
              echo "  ✓ Issue already exists (#$existing_issue). Skipping."
              continue
            fi

            # 5. Construct Issue Body
            cat > /tmp/issue_body.txt << BODY_END
            ### Skipped ROCm Test: \`${test_name}\`

            This test is currently marked with \`@skipIfRocm\` and needs to be addressed.

            - **File:** \`${filepath}\`
            - **Line:** ${line_number}
            - **Reason:** ${skip_reason}

            [View Code](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/${filepath}#L${line_number})

            ---
            *Auto-generated by Skipped Test Tracker*
            BODY_END

            # 6. Create Issue (or Log if Dry Run)
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "  [DRY RUN] Would create issue for $test_name assigned to $ASSIGNEE in project $PROJECT_NAME"
            else
              # Attempt creation. We do not exit on fail (|| true) so one error doesn't stop the whole batch.
              gh issue create \
                --repo "${{ github.repository }}" \
                --title "[ROCm Skip] ${test_name}" \
                --body-file /tmp/issue_body.txt \
                --label "rocm-skipped" \
                --assignee "$ASSIGNEE" \
                --project "$PROJECT_NAME" \
                || echo "  ❌ Error creating issue for ${test_name}. Check Assignee/Project permissions."
              
              echo "  ✓ Issue created."
              # Sleep to prevent hitting GitHub API abuse limits
              sleep 2
            fi

          done

          echo "=== Scan Complete ==="
